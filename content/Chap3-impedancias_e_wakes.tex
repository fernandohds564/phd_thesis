\chapter{Wakes and Impedances}\label{cap:wake_impedances}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{\engw{Wake Fields}}

In this section we are going to introduce the concept of wake field in particle accelerators and try to understand its foundations and main properties for the subsequent analysis of its influence over the movement of the charged particles in the accelerator. There are several approaches in the literature to explain this subject, the most appreciated by the author is the one presented in reference \cite{Stupakov2000a}, which will be reproduced in parts here.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Interaction Mechanisms}\label{ssec:interation_mechanisms}

Intuitively, we tend to think the direct interaction between charged particles, such as electric repulsion, is the responsible for the collective effects observed in storage rings, however, as we will see in the subsequent analysis, this is not the main mechanism for ultra-relativistic particles.

\begin{figure}[hb!]
\centering
\label{fig:wake1}
\begin{tikzpicture}[scale=1]
\def\d{1cm}
\draw[<->] (1,0) node[below]{$z$} 
		-- ++(-\d,0) node[below left] {$S$} 
        -- ++(0,\d) node[left] {$\rho$}; %coord sys S
\draw[<->] (6*\d,0) node[below]{$z'$}
		-- ++(-\d,0) node[below left] {$S'$} 
        -- ++(0,\d) node[left] {$\rho'$}; % coord sys S'
\coordinate (V) at (0.5,0);
\coordinate (Q1) at (4cm,1.5cm);
\coordinate (Q2) at (0.5cm,2.5cm);
\draw[->] (5*\d,0.5*\d) -- ++(V) node[above] {$\boldsymbol{v}$};
\filldraw[fill=black] (Q1) circle[radius=0.05] node[above] {$q$}; % source particle
\draw[->] (Q1) -- ++(V) node[above] {$\boldsymbol{v}$}; % velocity vector
\filldraw[fill=black] (Q2)  circle[radius=0.05]; % test particle
\draw[->] (Q2) -- ++(V) node[above] {$\boldsymbol{v}$}; % velocity vector
\draw[dashed,|-|] ($(Q1)-(0,0.2)$)
				   let \p1 = ($(Q2) - (Q1)$)
                   in -- ++(\x1,0) node[midway,below] {$s$}; %horizontal distance
\draw[dashed,|-|] ($(Q2)-(0.2,0)$)
				   let \p1 = ($(Q1) - (Q2)$)
                   in -- ++(0,\y1) node[midway,left] {$\rho$}; % vertical distance
\draw[->] (Q1) -- ++($(Q2) - (Q1)$) node[midway,above] {$\boldsymbol{R}$}; %vector
\end{tikzpicture}
\caption{Duas partÃ­culas interagindo via campo direto.}
\end{figure}

To see this lets consider the interaction of a source particle $Q$ moving with velocity $\vect{v}=v{\vect{\hat{z}}}$ with a witness particle $q$ moving with the same velocity (parallel path) at a distance $s$ in the direction parallel to the movement and at a transverse distance $\rho$, as shown in Figure\,\ref{fig:wake1}. We want to determine the force that the source particle exerts on the witness particle. One way to do this is by calculating the electric field of the source particle in the co-moving frame of reference, $S'$, and Lorentz transforming it back to the laboratory's frame. After the math we obtain:

\begin{align}
 \label{eq:fields_free_particle}
 \vect{E} = \frac{q}{4\pi\epsilon_0}\frac{\vect{R}}{\gamma^2 R^{*3}}, & & \vect{B} = \frac{1}{c^2}\vect{v} \times \vect{E} 
\end{align}
where $\vect{R}$ is the vector which connects both particles, going from the source to the witness and  $R^{*2} = s^2 + x^2/\gamma^2$, e $\gamma = 1/(1-v^2/c^2)$.

Combining equation\,\ref{eq:fields_free_particle} with the Lorentz force, we get the longitudinal and transverse force over the witness particle:
\begin{align}\label{eq:space_charge_force}
 F_l &= E_z = -\frac{q}{4\pi\epsilon_0}\frac{s}{\gamma^2\left(s^2+x^2/\gamma^2\right)^{3/2}}, \\
 F_t &= E_x - vB_y = -\frac{q}{4\pi\epsilon_0}\frac{x}{\gamma^4\left(s^2+x^2/\gamma^2\right)^{3/2}}
\end{align}

In accelerator physics the force $\vect{F}$ is known as space charge force. We can infer from equation\,\ref{eq:space_charge_force} that for any position $s$ and $x$, the longitudinal force is proportional to $\gamma^{-2}$ and $F_t \sim \gamma^{-4}$ if $s \gg x/\gamma$ and  $F_t \sim \gamma^{-1}$ if $s \approx 0$. This way, in the ultra-relativistic limit, $\gamma \to \infty$, the electromagnetic interaction between particles moving parallel to each other in free space is zero. It is easy to show that in this limit, if the movement of the particles is not parallel, there is an interaction force only for $s=0$, but, as their speed is the same, this situation can only happen for an infinitesimal time.


In this work we are interested in the the interaction between particles in the ultra-relativistic limit, $v \to c$. The space charge effects discussed above are despicable in this limit and the interaction between the particles is due to the presence of the walls of the vaccum chamber. Note that taking the limit $v \to c$ in the equation\,\ref{eq:fields_free_particle} and remembering that $s = vt - z$, we can write the electromagnetic field of a ultra-relativistic charge as
\begin{align}
\vect{E} = \frac{q}{2\pi\epsilon_0}\frac{\vect{\hat{r}}}{r}\delta(z-ct), & & \vect{B} =\frac{1}{c}\vect{\hat{z}}\times\vect{E},
\end{align}
where $\vect{r} = \vect{\hat{x}}x + \vect{\hat{y}}y$ is a bidimensional vector in cylindrical coordinates ($\vect{\hat{x}}$ and $\vect{\hat{y}}$ are unit vectors in the $x$ e $y$ directions, respectively). The equations above show that the field is pancake-like and follow the beam as it travels througth the empty space. It is important to notice that this solution is steady-state, it was necessary an infinite amount of time before $t$ to build it and that's why there is no causal paradoxes in it.

\begin{figure}[hb!]
\centering
\label{fig:wake2}
\begin{tikzpicture}
\draw[very thick] (0,0) -- ++(10,0) (0,4) -- ++(10,0); %vacuum chamber
\draw[dashed] (0,2) -- ++(10,0); %eixo de simetria
\coordinate (V) at (0.5,0);
\coordinate (Q1) at (4cm,2.2cm);
\coordinate (Q2) at (0.5cm,2.5cm);
\filldraw[fill=black] (Q1) circle[radius=0.05] node[left] {$q$}; % source particle
\draw[->] (Q1) -- ++(V) node[above] {$\boldsymbol{v}$}; % velocity vector
\draw[-{Stealth[length=10pt]}] (Q1) let \p1 = (Q1) in --(\x1,4);
\draw[-{Stealth[length=10pt]}] (Q1) let \p1 = (Q1) in --(\x1,0) node[midway,right] {$\boldsymbol{E}$};
\draw ($(Q1)+(0,1)$) circle[radius=0.2] node[right=0.2] {$\boldsymbol{B}$};
\filldraw ($(Q1)+(0,1)$) circle[radius=0.07];
\end{tikzpicture}
\caption{Particles interacting in a perfectly conducting cylindrical tube.}
\end{figure}

Lets consider now a pipe with cylindrical symmetry\footnote{do not confuse cylindrical symmetry with cylinder. By cylindrical symmetry we mean a system with translational symmetry in one direction.}, hollow and with absolute vacuum in its interior, made of a perfect electric conductor material and with arbitrary cross section. If we put the particles of the previous example inside this pipe, moving parallel to symmetry axis, they will induce image charges in the surface of the wall which cancel the electromagnetic field inside the metal. 

The image charges travel with the same velocity $\vect{v}$ of the particles (see Figure\,\ref{fig:wake2}). As they move in parallel paths with constant velocity, in the limit $v \to c$, according to the previous results, they do not interact, independently of how close they are from each other.

From this analysis we conclude that the interaction between particles in the ultra-relativistic limit can occur only for two reasons:
\begin{itemize}
    \item The wall is not perfectly conducting, or
    \item The pipe does not have cylindrical symmetry (which generally is due to the presence of RF cavities, flanges, bellows, beam position monitors, vacuum pumps, among other elements in the vacuum chamber of an accelerator).
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Causality and catch up distance}

If one particle moves in a straight line at light speed, the electromagnetic field scattered by the discontinuities of the chamber will not catch up with it and will not affect the charges travelling ahead of it. The field will only interact with the charges moving behind of the source particle. Such property is known as causality.

Even though this property is not strictly true in the real world, because particles always travel at speeds lower than the light's, it is true in most practical cases, as we will se bellow.

Lets try to calculate the distance $z$ where the field generated by some discontinuity in the vacuum chamber will catch up with a witness particle at a distance $s$ behind the source particle. At the time $t=0$ the source particle passes through the discontinuity and an electromagnetic wave is generated with its wave front travelling at the speed of light in all directions, forming a sphere of radius $R$, see FigureXX. At any given time after this, the following relation holds:
\begin{align}
ct = R \quad vt = z && \Rightarrow && R = \frac{z}{\beta} \quad \text{where} \,\, \beta = \frac{v}{c}
\end{align}
where $z$ is the distance travelled by the source particle. Besides that, at the specific time when the wake catchs up with the witness particle, the following relation is valid:
\begin{align}
R^2 = b^2 + (z-s)^2 && \Rightarrow &&
z^2(\frac{1}{\beta^2}-1) + 2sz - (b^2 + s^2) = 0 && \Rightarrow \\
z = -\gamma^2 \beta^2 s + \sqrt{s^2\gamma^4\beta^4 + \gamma^2\beta^2\left(b^2 + s^2\right)} && = \gamma^2 \beta^2 s\left(-1 + \sqrt{1 + \frac{1}{\gamma^2\beta^2}\left(1 + \frac{b^2}{s^2}\right)}\right) &&
\end{align}
where $b$ is the distance from the discontinuity to the trajectory of the particles and $\gamma = 1/\sqrt{1-\beta^2}$ is the relativistic energy. FigureXX shows a graphic of this function, normalized by the distance $b$. We notice that, for $s=0$, which means the field catching up with the source particle, $z = \gamma\beta b$. For the case of Sirius, $\gamma \approx 5870$ and $\beta \approx 1$, if $ b = 2$mm, $z \approx 12$m.

\begin{figure}[hb!]
\centering
\label{fig:catch_up}
\begin{tikzpicture}
\draw[very thick] (0,0) -- ++(10,0) (0,4) -- ++(10,0); %vacuum chamber
\draw[very thick] (4.8,4) to [out=-90,in=0] (5,3.8) to [out=180,in=-90] (5.2,4);
\draw[dashed] (0,2) -- ++(10,0); %eixo de simetria
\coordinate (V) at (0.5,0);
\coordinate (Q1) at (4cm,2.2cm);
\coordinate (Q2) at (0.5cm,2.5cm);
\filldraw[fill=black] (Q1) circle[radius=0.05] node[left] {$q$}; % source particle
\draw[->] (Q1) -- ++(V) node[above] {$\boldsymbol{v}$}; % velocity vector
\draw[-{Stealth[length=10pt]}] (Q1) let \p1 = (Q1) in --(\x1,4);
\draw[-{Stealth[length=10pt]}] (Q1) let \p1 = (Q1) in --(\x1,0) node[midway,right] {$\boldsymbol{E}$};
\draw ($(Q1)+(0,1)$) circle[radius=0.2] node[right=0.2] {$\boldsymbol{B}$};
\filldraw ($(Q1)+(0,1)$) circle[radius=0.07];
\end{tikzpicture}
\caption{The catch up distance.}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{DefiniÃ§Ã£o de Wake}\label{ssec:wake_definition}

The Electromagnetic interaction of charged particles with the environment generally has a small effect when compared with the effect of the guiding electric and magnetic fields of the accelerators components and can be treated as a perturbation. In an zeroth order approximation we can assume the beam moves with constant speed in a straight line and solve Maxwell equations 
A interaÃ§Ã£o eletromagnÃ©tica de partÃ­culas carregadas com o ambiente normalmente tem um efeito pequeno quando comparado com o efeito de campos elÃ©tricos e magnÃ©ticos externos dos aceleradores e pode ser considerada com uma perturbaÃ§Ã£o. Em uma aproximaÃ§Ã£o de ordem zero, podemos assumir que o feixe se move com velocidade constante em uma linha reta, e entÃ£o resolvemos as equaÃ§Ãµes de Maxwell, encontramos os campos e computamos o efeitos desses campos no movimento das partÃ­culas. Com essa abordagem negligenciamos efeitos de segunda ordem porque o movimento em uma Ã³rbita perturbada podem gerar apenas uma pequena mudanÃ§a nos campos computados pela aproximaÃ§Ã£o de ordem zero. Essas correÃ§Ãµes sÃ£o geralmente pequenas, especialmente para partÃ­culas ultra-relativÃ­sticas.

Outra importante caracterÃ­stica da interaÃ§Ã£o entre o campo eletromagnÃ©tico gerado e as partÃ­culas Ã© que em muitos casos de importÃ¢ncia prÃ¡tica eles estÃ£o localizados em uma regiÃ£o pequena comparada com o tamanho da Ã³rbita do feixe. Ela tambÃ©m ocorre uma escala de tempo muito menor que a de oscilaÃ§Ã£o do feixe no acelerador (como os perÃ­odos bÃ©tatron e sÃ­ncrotron). Isso nos permite considerar essa interaÃ§Ã£o dentro da aproximaÃ§Ã£o de impulso e caracterizÃ¡-la pelo momento transferido para a partÃ­cula.

Dessa forma, podemos introduzir a noÃ§Ã£o de \engw{wake} da seguinte maneira. Considere a partÃ­cula 1, com carga $q$ se movendo ao longo do eixo $z$ com uma velocidade prÃ³xima Ã  da luz, $v\approx c$, de modo que $z=ct$ (veja a figura \ref{fig:4}). Uma partÃ­cula 2 com carga unitÃ¡ria se move paralelamente Ã  partÃ­cula 1, com a mesma velocidade, a uma distÃ¢ncia $s$ com deslocamento transversal $\vect{\rho}$ relativo ao eixo $z$. O vetor $\vect{\rho}$ Ã© um vetor bi-dimensional perpendicular ao eixo $z$, $\vect{\rho} = (x,y)$. Apesar de as partÃ­culas viajarem no vÃ¡cuo, hÃ¡ contornos materiais no problema que espalham o campo eletromagnÃ©tico que gera uma interaÃ§Ã£o entre as partÃ­culas.

Assumindo que as equaÃ§Ãµes de Maxwell foram resolvidas e que os campos gerados pela partÃ­cula 1 foram encontrados, podemos calcular a mudanÃ§a no momento $\Delta \vect{p}$ da segunda partÃ­cula causada por esse campo como uma funÃ§Ã£o do deslocamento $\vect{\rho}$ e da distÃ¢ncia $s$,

\begin{equation}
 \Delta \vect{p}(\vect{\rho},s) = \defint{t}{\left[\vect{E}(\vect{\rho},z,t) + \vect{\hat{z}}\times \vect{B}(\vect{\rho},z,t)\right]_{z=ct-s}}{-\infty}{\infty}.
\end{equation}

Note que a integral Ã© feita sobre uma linha reta --- a Ã³rbita nÃ£o perturbada da segunda partÃ­cula. Os limites de integraÃ§Ã£o sÃ£o estendidos de menos para mais infinito assumindo que a integral converge.

Como a dinÃ¢mica do feixe Ã© diferente nas direÃ§Ãµes longitudinal e transversal, Ã© Ãºtil separar o momento longitudinal $\Delta p_z$ da componente transversal $\vect{\Delta p}_\perp$. Dessa forma, com uma convenÃ§Ã£o de sinal e um fator de normalizaÃ§Ã£o $c/q$, podemos definir as chamadas \engw{wake functions}, ou simplesmente \engw{wakes} longitudinal e transversal,

\begin{equation}\label{eq:wake_definition}\begin{aligned}
    w_l(\vect{\rho},s) &= -\frac{c}{q} \Delta p_z = -\frac{c}{q} \udefint{t}{E_z|_{z=ct-s}}, \\
    \vect{w}_t(\vect{\rho},s) &= \frac{c}{q} \vect{\Delta p}_\perp = \frac{c}{q} \udefint{t}{\left[\vect{E}_\perp + \vect{\hat{z}}\times \vect{B}\right]_{z=ct-s}}
\end{aligned}\end{equation}

Note o sinal de menos na definiÃ§Ã£o de $w_l$ --- ele Ã© introduzido para que um \engw{wake} longitudinal positivo corresponda a uma perda de energia da partÃ­cula teste (caso ambas a partÃ­cula fonte e teste tenham o mesmo sinal de carga). Os \engw{wakes} definidos tem dimensÃ£o de \si{\volt\per\coulomb} no Sistema Internacional de Unidades.

Por causa do princÃ­pio de causalidade o \engw{wakefield} nÃ£o se propaga a frente da partÃ­cula fonte, entÃ£o
\begin{equation}
    w_l(\vect{\rho},s) = 0, \qquad \vect{w}_t(\vect{\rho},s) = \vect{0}, \qquad \mathrm{para } \quad s < 0.
\end{equation}

Na definiÃ§Ã£o acima foi assumido que o campo eletromagnÃ©tico estava localizado no espaÃ§o e no tempo e que a integral na equaÃ§Ã£o \ref{eq:wake_definition} converge. Contudo, hÃ¡ casos em que isso nÃ£o Ã© verdade e a fonte do \engw{wake} Ã© distribuida uniformemente em um longo caminho, como Ã© o caso do \engw{wake} de parede resistiva de uma cÃ¢mara de vÃ¡cuo. Nesse caso Ã© mais conveniente introduzir o \engw{wake} por unidade de comprimento, descartando a integraÃ§Ã£o na equaÃ§Ã£o \ref{eq:wake_definition}:

\begin{equation}\begin{aligned}
    w_l(\vect{\rho},s) &= -\frac1q E_z|_{z=ct-s}, \\
    \vect{w}_t(\vect{\rho},s) &= \frac1q\left[\vect{E}_\perp + \vect{\hat{z}}\times \vect{B}\right]_{z=ct-s}.
\end{aligned}\end{equation}

Nessa definiÃ§Ã£o os \engw{wakes} adquirem uma dimensÃ£o adicional de inverso de comprimento e tem dimensÃ£o \si{\volt\per\coulomb\per\meter} no Sistema Internacional de Unidades.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Teorema de Panofsky-Wenzel}

VÃ¡rias relaÃ§Ãµes gerais entre os \engw{wakes} longitudinal e transversal podem ser obtidas das equaÃ§Ãµes de Maxwell sem que seja necessÃ¡rio especificar as condiÃ§Ãµes de contorno para os campos.

Vamos introduzir o vetor $\vect{R} =(\vect{\rho},-s)$ (o sinal de menos na frente do $s$ Ã© devido ao fato de $s$ ser positivo para posiÃ§Ãµes atrÃ¡s da partÃ­cula fonte) e considerar o momento $\vect{\Delta p}$ na equaÃ§Ã£o \ref{eq:wake_definition} como uma funÃ§Ã£o de $\vect{R}$. Vamos assumir que o campo eletromagnÃ©tico Ã© especificado atravÃ©s do potencial vetor $\vect{A}(\vect{r},t)$ e o potencial escalar $\phi(\vect{r},t)$, e computar
$\vect{\Delta p}$ para os dados campos. Ã conveniente usar a formulaÃ§Ã£o Lagrangiana para as equaÃ§Ãµes de movimento,

\begin{equation}\label{eq:euler_lagrange}
    \dertot{}{t}\derpar{L}{\vect{v}} = \derpar{L}{\vect{r}} = \vect{\nabla}L,
\end{equation}
com a Lagrangiana para a partÃ­cula teste com carga unitÃ¡ria Ã©
\begin{equation}\label{eq:lagrangiana_charged_part}
   L = -mc^2 \sqrt{1 - \frac{v^2}{c^2}} + \frac1c \vect{Av} - \phi
\end{equation}
substituindo a equaÃ§Ã£o \ref{eq:lagrangiana_charged_part} na equaÃ§Ã£o \ref{eq:euler_lagrange} obtemos:

\begin{equation}
 \dertot{}{t} \left(\vect{p} + \frac1c \vect{A}\right) = \vect{\nabla}\left(\frac1c \vect{Av} - \phi\right).
\end{equation}
onde $\vect{p} = m\gamma\vect{v}$.

Agora, integrando esta equaÃ§Ã£o ao longo da Ã³rbita da partÃ­cula teste, $x=\mathrm{const}$, $y=\mathrm{const}$ e $z = ct-s$, e assumindo que os campos $\vect{A}$ e $\phi$ vÃ£o a zero no infinito, encontramos

\begin{equation}
 \vect{\Delta p}(\vect{R}) = \udefint{t}{\vect{\nabla}\left(\frac1c\vect{Av} - \phi \right) = \frac{q}{c} \vect{\nabla_R}W(\mathrm{R})}.
\end{equation}
onde introduzimos o \engw{wake potential} $W$,
\begin{equation}
 W(\vect{R}) = \frac{c}{q}\udefint{t}{\left(\frac1c \vect{Av} -\phi\right)}
      \overset{\vect{v} \approx c\vect{\hat{z}}}{=}
                 \frac{c}{q}\udefint{t}{\left(A_z -\phi\right)}.
\end{equation}

Assim, provamos uma relaÃ§Ã£o que estabelece que todas as trÃªs componentes do vetor $\vect{\Delta p}$ podem ser obtidas derivando uma Ãºnica funÃ§Ã£o escalar $W$. Relembrando a relaÃ§Ã£o entre os componentes de $\vect{\Delta p}$ e os \engw{wakes}, \ref{eq:wake_definition}, descobrimos que

\begin{equation}\label{eq:wake_function_definition}
 w_l = - \derpar{W}{(-s)} = \derpar{W}{s},\qquad \vect{w}_l = \vect{\nabla_\rho}W,
\end{equation}
e, consequentemente
\begin{equation}\label{eq:panofsky_wenzel_theorem}
 \derpar{\vect{w}_t}{s} = \vect{\nabla_\rho}w_l.
\end{equation}

Esta relaÃ§Ã£o Ã© comumente chamada de teorema de Panofsky-Wenzel. Note que $\nabla_\rho$ Ã© um gradiente bidimensional com respeito Ã s coordenadas $x$ e $y$.

Uma das aplicaÃ§Ãµes computacionais mais importantes do teorema de Panofsky-Wenzel Ã© que o conhecimento do \engw{wake function}, $w_l$, longitudinal nos permite encontrar o \engw{wake} transversal,$\vect{w}_t$ por meio de uma integraÃ§Ã£o simples da equaÃ§Ã£o \ref{eq:panofsky_wenzel_theorem}.

Outra propriedade importante de $W$ Ã© que ele Ã© uma funÃ§Ã£o harmÃ´nica das variÃ¡veis $x$ e $y$,
\begin{equation}\label{eq:wake_potential_harmonic}
 \Delta_\perp W \equiv \derpar[2]{W}{x} + \derpar[2]{W}{y} = 0.
\end{equation}
Para provar isso vamos usar o fato que ambos $\vect{A}$ e $\phi$ satisfazem a equaÃ§Ã£o de onda no espaÃ§o livre, $(\partial^2/\partial t^2 - c^2 \Delta)\vect{A} = \vect{0}$ e $(\partial^2/\partial t^2 - c^2 \Delta)\phi = 0$. Dessa forma,

\begin{equation}\begin{aligned}
0
&=\frac{c}{q}\udefint{t}{\left(\derpar[2]{}{t}-c^2\Delta\right)\!\!(A_z-\phi)}\\
&=\frac{c}{q}\left[\udefint{t}{\left(\derpar[2]{}{t} - c^2\derpar[2]{}{z}\right)} -
	            c^2\udefint{t}{\left(\derpar[2]{}{x} + \derpar[2]{}{y}\right)}\right]\!\!(A_z-\phi)\\
&=\frac{c}{q}\udefint{t}{\left(\derpar{}{t}+c\derpar{}{z}\right)
				     \!\!\left(\derpar{}{t}-c\derpar{}{z}\right)\!\!(A_z -\phi)}
   -c^2\!\left(\derpar[2]{W}{x} + \derpar[2]{W}{y}\right)
\end{aligned}\end{equation}

A Ãºltima integral nessa equaÃ§Ã£o Ã© nula porque
\begin{equation}
    \derpar{}{t} + c\derpar{}{z} \approx \derpar{}{t} + \vect{v\nabla} = \dertot{}{t}
\end{equation}
e
\begin{equation}
  \udefint{t}{\left(\derpar{}{t} + c\derpar{}{z}\right)\!\!
             \left(\derpar{}{t} - c\derpar{}{z}\right)\!\!(A_z - \phi)}
  = \udefint{t}{\dertot{}{t}\!\!\left(\derpar{}{t}-c\derpar{}{z}\right)\!\!(A_z - \phi)}
  =  0.
\end{equation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Sistemas Com Um Eixo de Simetria}
Na seÃ§Ã£o \ref{ssec:wake_definition} nÃ³s definimos o \engw{wake} como uma funÃ§Ã£o do deslocamento da partÃ­cula teste relativo ao caminho da partÃ­cula fonte. Em aplicaÃ§Ãµes prÃ¡ticas nÃ³s tambÃ©m estamos interessados em saber como o \engw{wake} depende da trajetÃ³ria da partÃ­cula fonte. Assumiremos que o sistema em consideraÃ§Ã£o tem um eixo de simetria e vamos escolhe-lo como o eixo $z$ do sistema de coordenadas, veja \ref{fig:5}. Agora a partÃ­cula fonte, $1$, se move na direÃ§Ã£o $z$ com um deslocamento dado pelo vetor $\vect{\rho'}$, e a partÃ­cula teste viaja paralelamente Ã  partÃ­cula fonte, com a mesma velocidade, a uma distÃ¢ncia $s$ atrÃ¡s da fonte com um deslocamento $\vect{\rho}$ relativo ao eixo. Os vetores $\vect{\rho'}$ e $\vect{\rho}$ sÃ£o os vetores bidimensionais perpendiculares ao eixo $z$. O \engw{wake} ainda Ã© definido pela equaÃ§Ã£o \eqref{eq:wake_definition} mas agora ele serÃ¡ considerado como uma funÃ§Ã£o de $\vect{\rho'}$, $\vect{\rho}$ e $s$
\begin{equation}\begin{aligned}
w_l &= w_l(\vect{\rho},\vect{\rho'},s), \\
\vect{w}_t &= \vect{w}_t(\vect{\rho},\vect{\rho'},s).
\end{aligned}\end{equation}

Normalmente a cÃ¢mara de vÃ¡cuo Ã© projetada de forma que o eixo do sistema serve como uma Ã³rbita ideal para o feixe. Assim, desvios desse eixo sÃ£o relativamente pequenos e ambos os vetores $\vect{\rho'}$ e $\vect{\rho}$ sÃ£o tipicamente muito menores que a cÃ¢mara de vÃ¡cuo, de forma que em $w_l$ podemos negligenciÃ¡-los e introduzir um \engw{wake} longitudinal que sÃ³ depende de $s$,

\begin{equation}
	w_l(s) = w_l(\vect{0},\vect{0},s).
\end{equation}

Se os elementos que formam a cÃ¢mara de vÃ¡cuo tambÃ©m tem alguma simetria (por exemplo, se eles tem seÃ§Ã£o transversal circular, elÃ­ptica ou retangular), o \engw{wake} transverso no eixo, onde $(\vect{\rho},\vect{\rho'}) = (\vect{0},\vect{0})$, Ã© nulo, $\vect{w}_t(\vect{0},\vect{0},s)=\vect{0}$. Para pequenos valores de $(\vect{\rho},\vect{\rho'})$ nÃ³s podemos expandir $\vect{w}_t(\vect{\rho},\vect{\rho'},s)$ mantendo apenas os termos lineares. Dessa forma, obtemos uma relaÃ§Ã£o tensorial entre os \engw{wakes} transversos e os deslocamentos,

\begin{equation}
	\vect{w}_t(\vect{\rho},\vect{\rho'},s) = \overleftrightarrow{\vect{W}_1}(s)\vect{\rho} +
    										 \overleftrightarrow{\vect{W}_2}(s)\vect{\rho'},
\end{equation}
onde $\overleftrightarrow{\vect{W}_1}$ e $\overleftrightarrow{\vect{W}_2}$ sÃ£o tensores bidimensionais de ordem 2. 

\subsection{Sistemas com Simetria axial}

Em um sistema com simetria axial, o \engw{wake potential}, $W$, depende apenas dos mÃ³dulos de $\vect{\rho}$ e $\vect{\rho'}$ e do Ã¢ngulo, $\theta$ entre eles. Sempre podemos escolher um sistema de coordenadas tal que o vetor $\vect{\rho'}$ fique no plano $xz$, veja a figura \ref{fig:6}, de forma que $W$ serÃ¡ uma funÃ§Ã£o periÃ³dica e par \todo{entender porque Ã© par} do Ã¢ngulo $\theta$ em um sistema de coordenadas cilÃ­ndrico. Decompondo $W$ em sÃ©ries de Fourier em $\theta$ temos:

\begin{equation}
	W(\rho,\rho',\theta,s) = \sum_{m=0}^\infty W_m (\rho,\rho',s) \cos(m\theta).
\end{equation}

Inserindo essa equaÃ§Ã£o na equaÃ§Ã£o \eqref{eq:wake_potential_harmonic}, temos

\begin{equation}
	\sum_{m=0}^\infty \left(\frac1\rho\derpar{}{\rho}\rho\derpar{W_m}{\rho} - 
    					    \frac{m^2}{\rho^2}W_m\right)\cos(m\theta) = 0
\end{equation}
de onde podemos encontrar a dependÃªncia explÃ­cita em $\rho$ de $W$,
\begin{equation}\label{eq:wake_potential_of_rho}
	W_m(\rho,\rho',s) = A_m(\rho',s)\rho^m.
\end{equation}
Na equaÃ§Ã£o \eqref{eq:wake_potential_of_rho} a soluÃ§Ã£o singular na origem, $W_m \propto \rho^{-m}$ foi descartada.

TambÃ©m Ã© possÃ­vel encontrar a dependÃªncia de $W_m$ em funÃ§Ã£o de $\rho'$, \todo{Achar essa derivaÃ§Ã£o e incluir aqui} ver \cite{Bane_PAC1983}, que Ã©
\begin{equation}
	A_m(\rho',s) = F_m(s)\rho'^m.
\end{equation}

Usando a equaÃ§Ã£o \eqref{eq:wake_function_definition} podemos calcular os \engw{wake functions}
\begin{equation}
	w_l = \sum w_l^{(m)}, \qquad \vect{w}_t = \sum \vect{w}_t^{(m)}
\end{equation}
onde
\begin{equation}\label{eq:wake_function_cylindrical}\begin{aligned}
w_l^{(m)} &= \rho'^m\rho^mF'_m(s)\cos(m\theta),\\
\vect{w}_t^{(m)} &= m\rho'^m\rho^{m-1} F_m(s)\left[\vect{\hat{r}}\cos(m\theta) - 
												  \vect{\hat{\theta}}\sin(m\theta)\right]
\end{aligned}\end{equation}
onde $\vect{\hat{r}}$ e $\vect{\hat{\theta}}$ sÃ£o vetores unitÃ¡rios nas direÃ§Ãµes radial e azimutal no sistema cilÃ­ndrico de coordenadas e $F'_m$ Ã© a derivada de $F_m$ em relaÃ§Ã£o Ã  $s$. Lembre que nessas equaÃ§Ãµes nÃ³s assumimos que a partÃ­cula fonte estÃ¡ em $\theta = 0$.

As equaÃ§Ãµes \eqref{eq:wake_function_cylindrical} sÃ£o vÃ¡lidas para valores arbitrÃ¡rios de $\rho$ e $\rho'$. PrÃ³ximo ao eixo, onde os deslocamentos sÃ£o pequenos, os termos de ordem mais alta, com valores grandes de $m$, tambÃ©m ficam pequenos. Nesse caso podemos manter apenas os termos nÃ£o nulos de mais baixa ordem,
\begin{equation}\label{eq:wake_function_expanded}\begin{aligned}
	w_l & \equiv w_l^{(0)} = F'_0(s), \\
    \vect{w}_t & \equiv \vect{w}_t^{(1)} = F_1(s)\rho'\left(\vect{\hat{r}}\cos(\theta) - \vect{\hat{\theta}}\sin(\theta)\right) = \vect{\rho'} F_1(s)
\end{aligned}\end{equation}
onde a Ãºltima igualdade da Ãºltima equaÃ§Ã£o Ã© justificada porque $\vect{\hat{r}}\cos(\theta) - \vect{\hat{\theta}}\sin(\theta) = \vect{\hat{x}}$, que Ã© a direÃ§Ã£o em que estÃ¡ a partÃ­cula fonte, de acordo com nossa definiÃ§Ã£o inicial. 

Geralmente o \engw{wake} transversal definido na equaÃ§Ã£o \eqref{eq:wake_function_expanded} Ã© redefinido como
\begin{equation}
	w_t(s) \equiv \frac{|\vect{w}_t|}{|\vect{\rho'}|} = F_1(s)
\end{equation}
e adquire a unidade \si{\volt\per\coulomb\per\meter}. De acordo com essa definiÃ§Ã£o, um \engw{wake} transversal positivo significa um impulso na direÃ§Ã£o do deslocamento da partÃ­cula fonte (caso ambas cargas tenham o mesmo sinal).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{ImpedÃ¢ncias}

Nesta seÃ§Ã£o vamos definir o conceito de impedÃ¢ncia e derivar algumas de suas propriedades.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{DefiniÃ§Ã£o de ImpedÃ¢ncia}
O conhecimento dos \engw{wake functions} longitudinal e transversal nos dÃ¡ uma informaÃ§Ã£o completa, dentro da aproximaÃ§Ã£o de feixe rÃ­gido, sobre a interaÃ§Ã£o eletromagnÃ©tica do feixe com o seu ambiente. Contudo, em muitos casos, especialmente no estudo de instabilidades do feixe, Ã© mais conveniente usar a Transformada de Fourier dos \engw{wake functions} ou as impedÃ¢ncias. TambÃ©m, geralmente Ã© mais fÃ¡cil calcula a impedÃ¢ncia para uma dada geometria da cÃ¢mara de vÃ¡cuo ao invÃ©s da \engw{wake function}.

Por razÃµes histÃ³ricas a impedÃ¢ncias longitudinal, $Z_l$, e transversal, $Z_t$, sÃ£o definidas como a Transformada de Fourier dos \engw{wakes} com fatores multiplicativos diferentes,
\begin{equation}\label{eq:impedances_definition}\begin{aligned}
Z_l(\omega) &= \frac1c \defint{s}{w_l(s)e^{i\omega s/c}}{0}{\infty},\\
Z_t(\omega) &= -\frac{i}{c} \defint{s}{w_t(s)e^{i\omega s/c}}{0}{\infty}.
\end{aligned}\end{equation}
Note que a integraÃ§Ã£o na equaÃ§Ã£o \eqref{eq:impedances_definition} pode ser estendida para a regiÃ£o de valores negativos de $s$, porque $w_l$ e $w_t$ sÃ£o nulos naquela regiÃ£o. AlÃ©m disso, a impedÃ¢ncia pode ser definida para valores complexos de $\omega$, desde que $\Im(\omega) > 0 $ para que a integral convirja. Dessa forma, a impedÃ¢ncia Ã© uma funÃ§Ã£o analÃ­tica no plano superior da variÃ¡vel complexa $\omega$.

Um aspecto importante a respeito da definiÃ§Ã£o de impedÃ¢ncia Ã© que hÃ¡ divergÃªncias em sua definiÃ§Ã£o na literatura. Por exemplo, as referÃªncias \cite{Zotter1993} e \cite{Wilson1987} definem a impedÃ¢ncia longitudinal como o complexo conjugado da equaÃ§Ã£o \eqref{eq:impedances_definition}. Nesse trabalho estamos seguindo a definiÃ§Ã£o das referÃªncias \cite{CHao1993,Stupakov2000a,Heifets1991}.

{\huge AtÃ© aqui}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{CÃ¡lculo dos wake-potential a partir do ECHOzR}

De acordo com a referÃªncia, temos que:

\begin{align}
W_{||}(x_0,y_0,x,y,s) &= \frac1w\sum_{m=1}^\infty W_m(y_0,y,s)\sin(k_{x,m}x_0)\sin(k_{x,m}x), \\
W_y(x_0,y_0,x,y,s) &= \frac1w\sum_{m=1}^\infty k_{x,m}W_{y,m}(y_0,y,s)\sin(k_{x,m}x_0)\sin(k_{x,m}x), \\
W_x(x_0,y_0,x,y,s) &= \frac1w\sum_{m=1}^\infty k_{x,m}W_{x,m}(y_0,y,s)\sin(k_{x,m}x_0)\cos(k_{x,m}x),
\end{align}
where $w$ is the half-width of the structure, $0<x<2w$ is the horizontal position of the trailing particle, $0<x_0<2w$ is the horizontal position of the source particle, $y$ is vertical position of the trailing particle, $y_0$ is vertical position of the source particle, $s=z-ct$ is the position of the trailing particle relative to the source particle and 
\begin{equation}
k_{x,m} = \frac{\pi}{2w}m
\end{equation}
The other terms are given by
\begin{align}
W_m(y_0,y,s)     &= W^{cc}_m(s)\cosh(k_{x,m}y_0)\cosh(k_{x,m}y) + W^{ss}_m(s)\sinh(k_{x,m}y_0)\sinh(k_{x,m}y), \\
W_{y,m}(y_0,y,s) &= S^{cc}_m(s)\cosh(k_{x,m}y_0)\sinh(k_{x,m}y) + S^{ss}_m(s)\sinh(k_{x,m}y_0)\cosh(k_{x,m}y), \\
W_{x,m}(y_0,y,s) &= S^{cc}_m(s)\cosh(k_{x,m}y_0)\cosh(k_{x,m}y) + S^{ss}_m(s)\sinh(k_{x,m}y_0)\sinh(k_{x,m}y), 
\end{align}
where
\begin{equation}
S^{cc}_m = \int_{-\infty}^s W^{cc}_m(s')\mathrm{d}s', \qquad S^{ss}_m = \int_{-\infty}^s W^{ss}_m(s')\mathrm{d}s'
\end{equation}
and the quantities $W^{cc}_m(s')$ and $W^{ss}_m(s')$ are related to the output of the softwares ECHOzR and ECHO2D by:
\begin{align}
W^{cc}_m(s') = \frac{W_m^M(y_0,y,s)}{\cosh(k_{x,m}y_0)\cosh(k_{x,m}y)} \\
W^{ss}_m(s') = \frac{W_m^E(y_0,y,s)}{\sinh(k_{x,m}y_0)\sinh(k_{x,m}y)}
\end{align}
where $W_m^M(y_0,y,s)$ and $W_m^M(y_0,y,s)$ are the results of the simulation with magnetic and electric boundary conditions, respectively.


Our objective is to obtain the formulas for the monopole longitudinal, dipole and quarupolar transverse wake functions at the point $\vec{v} = (x_0=w,y_0=0,x=w,y=0)$ from these results. The monopolar wakes are readly obtained:
\begin{align}
W_m(0,0,s) = W^{cc}_m(s) &\Rightarrow W_{||}(\vec{v}) = \frac1w\sum^\infty_{m=1,\mathrm{odd}} W^{cc}_m(s), \\
W_{y,m}(0,0,s) = 0 &\Rightarrow W_y(\vec{v}) = 0, \\
W_{x,m}(0,0,s) = S^{cc}_m(s) &\Rightarrow W_x(\vec{v}) = \frac1w\sum^\infty_{m=1} S^{cc}_m(s)\frac{\sin(m\pi)}{2} = 0
\end{align}
To calculate the dipolar and quadrupolar wakes, we need to take the first derivative of the transverse wakes at the point of interest, $\vec{v}$. It is easy to see that the first derivatives of the longitudinal wake are zero. For the transverse:

\begin{align}
W_{y,d}(s) &= \left.\frac{\mathrm{d}}{\mathrm{d}y_0}W_y\right|_{\vec{v}} = \frac1w\sum^\infty_{m=1,\mathrm{odd}} k_{x,m}^2 S^{ss}_m(s) = \frac1w\int_{-\infty}^s\sum^\infty_{m=1,\mathrm{odd}} k_{x,m}^2 W^{ss}_m(s') \mathrm{d}s',\\
W_{y,q}(s) &= \left.\frac{\mathrm{d}}{\mathrm{d}y}W_y\right|_{\vec{v}} = \frac1w\sum^\infty_{m=1,\mathrm{odd}} k_{x,m}^2 S^{cc}_m(s) = \frac1w\int_{-\infty}^s\sum^\infty_{m=1,\mathrm{odd}} k_{x,m}^2 W^{cc}_m(s') \mathrm{d}s', \\
W_{x,d}(s) &= \left.\frac{\mathrm{d}}{\mathrm{d}x_0}W_x\right|_{\vec{v}} = \frac1w\sum^\infty_{m=1,\mathrm{even}} k_{x,m}^2 S^{cc}_m(s) = \frac1w\int_{-\infty}^s\sum^\infty_{m=1,\mathrm{even}}k_{x,m}^2 W^{cc}_m(s') \mathrm{d}s', \\
W_{x,q}(s) &= \left.\frac{\mathrm{d}}{\mathrm{d}x}W_x\right|_{\vec{v}} = -\frac1w\sum^\infty_{m=1,\mathrm{odd}} k_{x,m}^2 S^{cc}_m(s) =-\frac1w\int_{-\infty}^s\sum^\infty_{m=1,\mathrm{odd}} k_{x,m}^2 W^{cc}_m(s') \mathrm{d}s'
\end{align}
and all the skew terms are zero.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Wake Calculation From GdfiDL Simulations}

First lets consider the general expansion of the Wake potential of a bunch in the transverse coordinates of the centroid of the source $(x_s,y_s)$ and the integration path $(x,y)$ up to third order:

\begin{align}
W(\vect{x},s) &= W_0(s) + \sum_{i=1}^4 M_i(s) x_i + \frac12\sum_{i,j=1}^4 D_{ij}(s) x_i x_j + \frac13\sum_{i,j,k=1}^4 Q_{ijk}(s) x_i x_j x_k
\end{align}
where we considered $\vect{x} = (x_1,x_2,x_3,x_4) = (x_s,y_s,x,y)$ and because of the commutative property of multiplication, we can set $D_{ij} = D_{ji}$ and $Q_{ijk}=Q_{kij}=Q_{jki}=Q_{ikj}=Q_{jik}=Q_{kji}$ without loss of generality. With these considerations, number of independent components of $D$ is 10 and $Q$ is 20. Besides that, the fact that $W$ is an harmonic function of the transverse coordinates of the integration path, imposes that
\begin{align}
D_{33} &= - D_{44} \\
Q_{33i} &= - Q_{44i}, \quad \text{with} \quad i=1,2,3,4
\end{align}
which leaves only nine independent components of $D$ and sixteen of $Q$.

Thus, the wake forces become:
\begin{align}
F_L(\vec{x},s) = W'(\vec{x},s) &= W_0' + \sum_{i=1}^4 M_i' x_i + \frac12\sum_{i,j=1}^4 D_{ij}' x_i x_j + \frac13\sum_{i,j,k=1}^4 Q_{ijk}' x_i x_j x_k \\
F_x(\vec{x},s) = \derpar{W(\vect{x},s)}{x} &= M_3 + \sum_{i=1}^4 D_{3i} x_i + \sum_{i,j=1}^4 Q_{3ij} x_i x_j \\
F_y(\vec{x},s) = \derpar{W(\vect{x},s)}{y} &= M_4 + \sum_{i=1}^4 D_{4i} x_i + \sum_{i,j=1}^4 Q_{4ij} x_i x_j
\end{align}

Generally we are interested in obtaining the linear terms as function of the transverse coordinates correct up to second order. It means we want to isolate the linear from the quadract terms in the simulations. Thus, lets keep only the second order terms in the wake forces above.
\begin{align}
F_L(\vect{x},s) &= W_0' + \vect{M'}^T \cdot \vect{x} + \frac12\vect{x}^T \cdot \tensor{D'}  \cdot \vect{x} \\
F_x(\vect{x},s) &= M_x + \vect{D_x}^T \cdot \vect{x} +        \vect{x}^T \cdot \tensor{Q_x} \cdot \vect{x} \\
F_y(\vect{x},s) &= M_y + \vect{D_y}^T \cdot \vect{x} +        \vect{x}^T \cdot \tensor{Q_y} \cdot \vect{x}
\end{align}
where
\begin{align}
\vect{M} &= \begin{pmatrix*}[r] M_{1}\\ M_{2}\\ M_{3}\\ M_{4}\end{pmatrix*} \\
\tensor{D}  &= \begin{pmatrix*}[r] D_{11} & D_{12} & D_{13} & D_{14} \\
                                   D_{21} & D_{22} & D_{23} & D_{24} \\
                                   D_{31} & D_{32} & D_{33} & D_{34} \\
                                   D_{41} & D_{42} & D_{43} & D_{44} 
               \end{pmatrix*} = 
               \begin{pmatrix*}[r] D_{11} & D_{12} & D_{13} & D_{14} \\
                                   D_{12} & D_{22} & D_{23} & D_{24} \\
                                   D_{13} & D_{23} & D_{33} & D_{34} \\
                                   D_{14} & D_{24} & D_{34} & -D_{33}  
               \end{pmatrix*}\\
\vect{D_x} &= \tensor{D}\cdot \vect{\hat{x}} \\
\vect{D_y} &= \tensor{D}\cdot \vect{\hat{y}} \\
\tensor{Q_x}&= \begin{pmatrix*}[r] Q_{311} & Q_{312} & Q_{313} & Q_{314} \\
                                   Q_{321} & Q_{322} & Q_{323} & Q_{324} \\
                                   Q_{331} & Q_{332} & Q_{333} & Q_{334} \\
                                   Q_{341} & Q_{342} & Q_{343} & Q_{344} 
               \end{pmatrix*} = 
               \begin{pmatrix*}[r] Q_{113} & Q_{123} & Q_{133} & Q_{134} \\
                                   Q_{123} & Q_{223} & Q_{233} & Q_{234} \\
                                   Q_{133} & Q_{233} & Q_{333} & Q_{334} \\
                                   Q_{134} & Q_{234} & Q_{334} & -Q_{333} 
               \end{pmatrix*}\\
\tensor{Q_y}&= \begin{pmatrix*}[r] Q_{411} & Q_{412} & Q_{413} & Q_{414} \\
                                   Q_{421} & Q_{422} & Q_{423} & Q_{424} \\
                                   Q_{431} & Q_{432} & Q_{433} & Q_{434} \\
                                   Q_{441} & Q_{442} & Q_{443} & Q_{444} 
               \end{pmatrix*} = 
               \begin{pmatrix*}[r] Q_{114} & Q_{124} & Q_{134} & Q_{133} \\
                                   Q_{124} & Q_{224} & Q_{234} & Q_{233} \\
                                   Q_{134} & Q_{234} & Q_{334} & -Q_{333} \\
                                   Q_{133} & Q_{233} &-Q_{333} & -Q_{334} 
               \end{pmatrix*}\\
\end{align}



Due to their importance, some components of the $D$ tensor have a name: the $D_{31}$ and $D_{42}$ are called dipolar wakes; and $D_{33}$ and $D_{44}$ are the quadrupolar wakes. While the first generates coherent tune-shifts and instabilities, the later is the responsible for incoherent tune-shifts of the beam. The other terms are the skew components, which are zero for most practical cases, as we will see below.

\subsection{Symmetry analysis}

When the geometry has symmetry the number of independent compononts in $M$, $D$ and $Q$ are reduced even more.
When the symmetry occurs in one plane, the number of independent components is two, five and eight, respectivelly.Below we list examples for the most practical cases:

\begin{itemize}
\item symmetry in the $yz$ plane, or $x=0$.
\begin{align}
W(x_s,y_s,x,y,s) = & W(-x_s,y_s,-x,y,s) \Rightarrow \\
M_2= & M_4=0\\
D_{12}=D_{14}= & D_{23}=D_{34}=0\\
Q_{111}=Q_{122}= & Q_{113}=Q_{223}=0\\
Q_{133}=Q_{333}= & Q_{124}=Q_{234}=0
\end{align}
\begin{align}
\vect{M}&= \begin{pmatrix} M_{1}\\ 0\\ M_{3}\\ 0\end{pmatrix} &
\tensor{D} &= \begin{pmatrix} D_{11} &    0   & D_{13} &    0    \\
                                  0   & D_{22} &    0   &  D_{24} \\
                               D_{13} &    0   & D_{33} &    0    \\
                                  0   & D_{24} &    0   & -D_{33}  
               \end{pmatrix}\\
\tensor{Q_x}&=\begin{pmatrix}    0    & Q_{123} &    0    & Q_{134} \\
                               Q_{123} &    0    & Q_{233} &    0    \\
                                  0    & Q_{233} &    0    & Q_{334} \\
                               Q_{134} &    0    & Q_{334} &    0    
               \end{pmatrix} &
\tensor{Q_y}&=\begin{pmatrix} Q_{114} &    0    & Q_{134} &    0    \\
                                  0    & Q_{224} &    0    & Q_{233} \\
                               Q_{134} &    0    & Q_{334} &    0    \\
                                  0    & Q_{233} &    0    & -Q_{334} 
               \end{pmatrix}
\end{align}

\item symmetry in the $xz$ plane, or $y=0$.
\begin{align}
W(x_s,y_s,x,y,s) = & W(x_s,-y_s,x,-y,s) \Rightarrow \\
M_1= & M_3=0\\
D_{12}=D_{14}= & D_{23}=D_{34}=0\\
Q_{112}=Q_{222}= & Q_{123}=Q_{233}=0\\
Q_{114}=Q_{224}= & Q_{134}=Q_{334}=0
\end{align}
\begin{align}
\vect{M}    &= \begin{pmatrix}   0  \\ M_{2}\\  0  \\ M_{4}\end{pmatrix} &
\tensor{D}  &= \begin{pmatrix} D_{11} &    0   & D_{13} &    0   \\
                                  0   & D_{22} &    0   & D_{24} \\
                               D_{13} &    0   & D_{33} &    0   \\
                                  0   & D_{24} &    0   & -D_{33}  
               \end{pmatrix}\\
\tensor{Q_x}&= \begin{pmatrix} Q_{113} &    0    & Q_{133} &    0    \\
                                  0    & Q_{223} &    0    & Q_{234} \\
                               Q_{133} &    0    & Q_{333} &    0    \\
                                  0    & Q_{234} &    0    & -Q_{333} 
               \end{pmatrix} &
\tensor{Q_y}&= \begin{pmatrix}    0    & Q_{124} &    0    & Q_{133} \\
                               Q_{124} &    0    & Q_{234} &    0    \\
                                  0    & Q_{234} &    0    & -Q_{333} \\
                               Q_{133} &    0    &-Q_{333} &    0    
               \end{pmatrix}
\end{align}

\item symmetry in the plane $y=x$.
\begin{align}
W(x_s,y_s,x,y,s) =& W(y_s,x_s,y,x,s) \Rightarrow \\
M_1=M_2, \quad & M_3=M_4\\
D_{11}=D_{22}, \quad D_{13}=D_{24}, \quad & D_{14}=D_{23}, \quad D_{33}=0 \\
Q_{111}=Q_{222}, \quad Q_{112}= Q_{122}, \quad & Q_{113}=Q_{224}, \quad Q_{114}= Q_{223} \\
Q_{123}=Q_{124}, \quad Q_{133}=-Q_{233}, \quad & Q_{134}=Q_{234}, \quad Q_{333}=-Q_{334}
\end{align}
\begin{align}
\vect{M}  &= \begin{pmatrix} M_{1}\\ M_{1}\\ M_{3}\\ M_{3}\end{pmatrix} &
\tensor{D}   &=\begin{pmatrix} D_{11} & D_{12} & D_{13} & D_{14} \\
                               D_{12} & D_{11} & D_{14} & D_{13} \\
                               D_{13} & D_{14} &    0   & D_{34} \\
                               D_{14} & D_{13} & D_{34} &    0    
               \end{pmatrix}\\
\tensor{Q_x}&= \begin{pmatrix} Q_{113} & Q_{123} & Q_{133} & Q_{134} \\
                               Q_{123} & Q_{114} &-Q_{133} & Q_{134} \\
                               Q_{133} &-Q_{133} & Q_{333} &-Q_{333} \\
                               Q_{134} & Q_{134} &-Q_{333} &-Q_{333} 
               \end{pmatrix} &
\tensor{Q_y} &=\begin{pmatrix} Q_{114} & Q_{123} & Q_{134} & Q_{133} \\
                               Q_{123} & Q_{113} & Q_{134} &-Q_{133} \\
                               Q_{134} & Q_{134} &-Q_{333} &-Q_{333} \\
                               Q_{133} &-Q_{133} &-Q_{333} & Q_{333} 
               \end{pmatrix}
\end{align}

\item symmetry in the plane $y=-x$.
\begin{align}
W(x_s,y_s,x,y,s) =& W(-y_s,-x_s,-y,-x,s) \Rightarrow \\
M_1=-M_2, \quad & M_3=-M_4\\
D_{11}=D_{22}, \quad D_{13}=D_{24}, \quad & D_{14}=D_{23}, \quad D_{33}=0 \\
Q_{111}=-Q_{222}, \quad Q_{112}=-Q_{122}, \quad & Q_{113}=-Q_{224}, \quad Q_{114}=-Q_{223} \\
Q_{123}=-Q_{124}, \quad Q_{133}= Q_{233}, \quad & Q_{134}=-Q_{234}, \quad Q_{333}= Q_{334}
\end{align}
\begin{align}
\vect{M}  &= \begin{pmatrix} M_{1}\\ -M_{1}\\ M_{3}\\ -M_{3}\end{pmatrix} &
\tensor{D}   &=\begin{pmatrix} D_{11} & D_{12} & D_{13} & D_{14} \\
                               D_{12} & D_{11} & D_{14} & D_{13} \\
                               D_{13} & D_{14} &    0   & D_{34} \\
                               D_{14} & D_{13} & D_{34} &    0    
               \end{pmatrix}\\
\tensor{Q_x}&= \begin{pmatrix} Q_{113} & Q_{123} & Q_{133} & Q_{134} \\
                               Q_{123} &-Q_{114} & Q_{133} &-Q_{134} \\
                               Q_{133} & Q_{133} & Q_{333} & Q_{333} \\
                               Q_{134} &-Q_{134} & Q_{333} &-Q_{333} 
               \end{pmatrix} &
\tensor{Q_y} &=\begin{pmatrix} Q_{114} &-Q_{123} & Q_{134} & Q_{133} \\
                              -Q_{123} &-Q_{113} &-Q_{134} & Q_{133} \\
                               Q_{134} &-Q_{134} & Q_{333} &-Q_{333} \\
                               Q_{133} & Q_{133} &-Q_{333} &-Q_{333} 
               \end{pmatrix}
\end{align}
\end{itemize}

Below we combine some of the above mentioned symmetries which are very commom in the simulations performed for accelerators elements:

\begin{itemize}
\item x=0 and y=0.
\begin{align}
\vect{M}= \vect{0} & &
\tensor{D} = \begin{pmatrix} D_{11} &    0   & D_{13} &    0    \\
                                  0   & D_{22} &    0   &  D_{24} \\
                               D_{13} &    0   & D_{33} &    0    \\
                                  0   & D_{24} &    0   & -D_{33}  
               \end{pmatrix} & &
\tensor{Q_x}=\tensor{0} & &
\tensor{Q_y}=\tensor{0}
\end{align}

\item $y=-x$ and $y=x$.
\begin{align}
\vect{M}= \vect{0} & &
\tensor{D}   &=\begin{pmatrix} D_{11} & D_{12} & D_{13} & D_{14} \\
                               D_{12} & D_{11} & D_{14} & D_{13} \\
                               D_{13} & D_{14} &    0   & D_{34} \\
                               D_{14} & D_{13} & D_{34} &    0    
               \end{pmatrix}& &
\tensor{Q_x}=\tensor{0} & &
\tensor{Q_y}=\tensor{0}
\end{align}

\item $x=0$, $y=0$, $y=-x$ and $y=x$.
\begin{align}
\vect{M}= \vect{0} & &
\tensor{D}   &=\begin{pmatrix} D_{11} &   0    & D_{13} &   0    \\
                                 0    & D_{11} &    0   & D_{13} \\
                               D_{13} &   0    &    0   &   0    \\
                                 0    & D_{13} &    0   &   0    
               \end{pmatrix} & &
\tensor{Q_x}=\tensor{0} & &
\tensor{Q_y}=\tensor{0}
\end{align}
\end{itemize}
where we notice that when there is at least 2 planes of symmetry, all the odd order terms are zero.

\subsection{GDFIDL Simulations}

One simulation in GDFIDL consists of passing a linear gaussian bunch with the velocity of light in the longitudinal direction and with a specific transverse position, say $(x_s,y_s)=(d_x,d_y)$ through the simulated structure solving Maxwell equations in time. While doing this, the code saves in memory the wake potential $W(d_x,d_y,x,y,s)$ for all transverse positions $(x,y)$ of integration and all $s$. This procedure is very time consuming and we gerally try to perform the mininum amount of simulations possible to get the results we need.

Lets suppose a simulation was performed with the position of the source in $(x_s,y_s)=(d,0)$. If we calculate the Horizontal Wake potential in a path where $y=0$ then, up to second order in the transverse coordinates we can write:

\begin{align}
F_L(d,0,x,0) &= W_0  +  M_1d  +  M_3x + D_{11}d^2 + D_{13}dx + D_{33}x^2 \\
F_x(d,0,x,0) &= M_x + D_{x3} x + D_{x1} d + Q_{x33} x^2 + Q_{x11} d^2 + Q_{x13} x d\\
F_y(d,0,x,0) &= M_y + D_{y3} x + D_{y1} d + Q_{y33} x^2 + Q_{y11} d^2 + Q_{y13} x d
\end{align}

Now, integrating the total wake in 4 different $x$ points we get:
\begin{align}
	F_1 = F_x(d,x_1) &= M_x  +  D_{x3} x_1  +  D_{x1} d  +  Q_{x33} x_1^2  +  Q_{x11} d^2  +  Q_{x13} x_1 d \\
    F_2 = F_x(d,x_2) &= M_x  +  D_{x3} x_2  +  D_{x1} d  +  Q_{x33} x_2^2  +  Q_{x11} d^2  +  Q_{x13} x_2 d \\
    F_3 = F_x(d,x_3) &= M_x  +  D_{x3} x_3  +  D_{x1} d  +  Q_{x33} x_3^2  +  Q_{x11} d^2  +  Q_{x13} x_3 d \\
    F_4 = F_x(d,x_4) &= M_x  +  D_{x3} x_4  +  D_{x1} d  +  Q_{x33} x_4^2  +  Q_{x11} d^2  +  Q_{x13} x_4 d
\end{align}

To extract the component $D_x$ from the total wake we do:
\begin{align}
\Delta_1 = \frac{F_1}{x_1} - \frac{F_2}{x_2} &= \left(M_x  +  D_{x1}d  +  Q_{x11}d^2\right)\left(\frac{1}{x_1}-\frac{1}{x_2}\right) + Q_{x33}(x_1-x_2) \\
\Delta_2 = \frac{F_3}{x_3} - \frac{F_4}{x_4} &= \left(M_x  +  D_{x1}d  +  Q_{x11}d^2\right)\left(\frac{1}{x_3}-\frac{1}{x_4}\right) + Q_{x33}(x_3-x_4)
\end{align}
then, remembering $(1/a-1/b)/(a-b) = -1/ab$ we get: 
\begin{align}
	\frac{\Delta_1}{x_1-x_2} - \frac{\Delta_2}{x_3-x_4} &= \left(M_x  +  D_{x1} d  +  Q_{x11} d^2\right)\left(\frac{1}{x_3x_4} - \frac{1}{x_1x_2}\right)
\end{align}
\begin{align}
	M_x  +  D_{x1} d +  Q_{x11} d^2 &= \left(\frac{x_1x_2x_3x_4}{x_3x_4 - x_1x_2}\right)\left(\frac{\Delta_1}{x_1-x_2} - \frac{\Delta_2}{x_3-x_4}\right)
\end{align}

Note that in general to isolate the dipolar component $D_x$, it is necessary to perform another two simulations. If another simulation is performed with the source at $(x_s,y_s) = (-d,0)$ it is also possible to isolate the dipolar component.

Now, lets try to extract the quadrupolar component
\begin{align}
\Delta_1 = \frac{F_1 - F_2}{x_1-x_2} &= D_{x3} + Q_{x13}d + Q_{x33}(x_1 + x_2)
\end{align}
Notice that, if we choose $x_2=-x_1$ the contribution from $Q_{x33}$ is canceled and
\begin{align}
	D_{x3} + Q_{x13}d = \Delta_1
\end{align}
where it is clear that is necessary other simulation to extract the quadrupolar wake.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Panofski-Wenzel}

O conceito de wake-function e impedÃ¢ncia tem seu surgimento motivado pelo teorema de Panofski-Wenzel. Esse teorema Ã© resultado de duas aproximaÃ§Ãµes feitas na anÃ¡lise do problema de duas partÃ­culas relativÃ­sticas interagindo entre si por meio de campos eletromagnÃ©ticos espalhados pela cÃ¢mara de vÃ¡cuo do anel de armazenamento. Por sua central importÃ¢ncia para o subsequente desenvolvimento desse trabalho, vamos olhar esse teorema com um pouco mais de detalhe.

Primeiro, vamos considerar a imagem apresentada na figura X, ou seja, consideremos uma situaÃ§Ã£o em que temos uma partÃ­cula de carga $Q$ atravessando a estrutura ilustrada com velocidade $\vec{v}$ ao longo da cÃ¢mara de vÃ¡cuo de um anel de armazenamento. A uma distÃ¢ncia longitudinal $z$ dela, uma partÃ­cula de prova com carga $q$ tambÃ©m atravessa a estrutura na mesma direÃ§Ã£o. Estamos interessados em saber qual Ã© a forÃ§a que essa carga de prova sentirÃ¡ ao longo de sua passagem por toda a estrutura. Pela equaÃ§Ã£o de Lorentz, temos a todo instante:
\begin{equation}
 \vec{F} = q\left(\vec{E} + \vec{v} \times \vec{B}\right)
\end{equation}
onde $\vec{E}$ e $\vec{B}$ Ã© o campo eletromagnÃ©tico na posiÃ§Ã£o da partÃ­cula que estÃ¡ sentindo a forÃ§a. Esse campo pode ser decomposto como a soma de vÃ¡rios campos com origem e interpretaÃ§Ã£o fÃ­sica diferentes: O campo externo, gerado pelos Ã­mÃ£s e cavidades de RF que guiam o feixe e o campo de interaÃ§Ã£o, que foi gerado pela partÃ­cula fonte, de carga $Q$. O campo de interaÃ§Ã£o ainda pode ser decomposto em duas contribuiÃ§Ãµes distintas: o campo direto, que existiria mesmo sem a presenÃ§a da cÃ¢mara de vÃ¡cuo e o campo indireto, resultado da interaÃ§Ã£o dessa carga com a cÃ¢mara de vÃ¡cuo. Para obter a transferÃªncia de momento total sentida pela carga de prova ao longo de toda estrutura, temos que integrar a equaÃ§Ã£o acima na trajetÃ³ria da partÃ­cula. Ao realizarmos esse procedimento, logo vemos que a soluÃ§Ã£o auto-consistente desse problema Ã© muito complexa, pois a trajetÃ³ria da partÃ­cula prova depende da forÃ§a que ela sentiu nos tempos anteriores, assim como da trajetÃ³ria da carga fonte, devido Ã  dependÃªncia dos campos eletromagnÃ©ticos que sÃ£o gerados por ela.

Assim, para conseguir seguir mais adiante na anÃ¡lise desse problema devemos fazer aproximaÃ§Ãµes. A primeira delas Ã© considerar que ambas as partÃ­culas sÃ£o rÃ­gidas e possuem velocidades paralelas uma com a outra e paralelas ao eixo de simetria da cÃ¢mara de vÃ¡cuo (caso a cÃ¢mara de vÃ¡cuo nÃ£o tenha simetria, considera-se a velocidade das partÃ­culas paralelas Ã  direÃ§Ã£o em que o feixe de elÃ©trons deverÃ¡ passar). Essa consideraÃ§Ã£o simplifica drasticamente a anÃ¡lise do problema, como veremos logo a seguir.

Antes de seguir com a demonstraÃ§Ã£o do teorema, vamos justificar essa aproximaÃ§Ã£o. Na maioria dos aceleradores de partÃ­culas as partÃ­culas estÃ£o no limite ultra-relativÃ­stico, em que sua velocidade Ã© aproximadamente a da luz e varia muito pouco com variaÃ§Ã£o de momento. Isso implica que nesse limite as partÃ­culas sÃ£o bastante rÃ­gidas

